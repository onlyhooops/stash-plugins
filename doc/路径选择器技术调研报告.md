# Stash 项目路径选择器实现细节调研报告

**文档版本**: 1.0  
**调研范围**: 路径筛选时的路径选择器 UI、单层目录结构（单叉结构）及前后端数据流  
**生成日期**: 2025-02-25  

---

## 1. 概述

路径选择器用于在**列表筛选**中按文件系统路径筛选（如 Scenes、Images、Galleries 的 Path 条件）。用户可通过**输入框**直接输入路径，或通过**可折叠的文件夹浏览器**逐层选择。浏览器每次只展示**当前目录的父级链接 + 直接子目录列表**，即「单层 / 单叉」结构：不展开整棵树，只显示一层，通过点击「上一级」或某个子目录再请求新一层数据。本报告说明该结构的实现细节。

### 1.1 核心结论摘要

| 项目 | 说明 |
|------|------|
| 筛选入口 | Path 条件使用 `PathFilter`，内部为 `FolderSelect` 或正则输入框 |
| 单叉结构 | 每次仅展示：一个「上一级」+ 当前路径下直接子目录列表；无多级树展开 |
| 目录数据 | GraphQL `directory(path)` 返回 `path`、`parent`、`directories[]` |
| 后端目录 | `listDir` 仅列当前目录子目录；`getParent` 为 `path/..` |
| 默认根 | 路径为空时用 `configuration.general.stashes` 作为默认可选目录（库根路径） |

---

## 2. 架构与文件结构

### 2.1 相关文件与职责

```
ui/v2.5/src/
├── components/List/Filters/
│   └── PathFilter.tsx              # 路径条件 UI：正则输入 或 FolderSelect
├── components/Shared/FolderSelect/
│   ├── FolderSelect.tsx            # 路径输入框 + 可折叠的「单层」目录列表
│   ├── FolderSelectDialog.tsx      # 弹窗封装 FolderSelect（它处使用）
│   └── useDirectoryPaths.ts        # 调用 useDirectory(path) 得到 directories + parent
├── models/list-filter/criteria/
│   └── path.ts                     # PathCriterionOption、PathCriterion（extends StringCriterion）
├── components/List/
│   └── CriterionEditor.tsx         # 根据 criterion 类型渲染 PathFilter 并绑定 onValueChanged
└── core/StashService.ts            # useDirectory(path) → Directory 查询

graphql/
├── schema/schema.graphql           # query directory(path, locale)
├── schema/types/config.graphql     # type Directory { path, parent, directories }
└── ui/v2.5/graphql/queries/settings/config.graphql  # query Directory($path: String)

internal/api/
├── resolver_query_configuration.go # Directory 解析：getDir、listDir、getParent
└── dir_list.go                     # listDir：ReadDir + 仅目录、排序
```

- **PathFilter**：在路径筛选中作为条件编辑器，根据 modifier 决定是正则输入框还是 FolderSelect；FolderSelect 时传入库路径为默认目录。
- **FolderSelect**：实现「输入框 + 可折叠列表」；列表内仅一层：父级链接 + 当前目录的直接子目录。
- **useDirectoryPaths**：对 `useDirectory(path)` 的封装，返回 `directories`、`parent`、`loading`、`error`。
- **PathCriterion**：继承 StringCriterion，默认 modifier 为 Includes，值即路径字符串（可选带引号）。

---

## 3. 单叉结构：UI 与数据流

### 3.1 「单叉」含义

- **单层展示**：不渲染整棵目录树，只渲染「当前路径」这一层的兄弟与父级。
- **当前层数据**：来自一次 `directory(path)` 请求，返回：
  - **parent**：当前路径的父目录（用于「上一级」）。
  - **directories**：当前路径下的**直接子目录**（仅一层）。
- **交互**：用户点击「上一级」则把 `parent` 设为当前路径并再次请求；点击某个子目录则把该子目录路径设为当前路径并再次请求。每次只看到一层，形成「单叉」导航。

### 3.2 FolderSelect 组件结构

**Props**：

- `currentDirectory`：当前选中的路径（与 criterion.value 同步）。
- `onChangeDirectory`：路径变更回调（写回 criterion）。
- `defaultDirectories`：可选，当 `currentDirectory` 为空时显示的目录列表（PathFilter 传入库路径）。
- `collapsible`：是否显示「…」按钮折叠/展开下方列表；PathFilter 中为 `true`。
- `quotePath`：路径含空格时是否自动加/去引号；PathFilter 中为 `true`。
- `hideError`：是否隐藏错误信息；PathFilter 中为 `true`。

**布局**：

1. **InputGroup**  
   - `Form.Control`：受控，`value={currentDirectory}`，`onChange` 防抖后调用 `onChangeDirectory` 并本地 `setPath`。  
   - 若 `collapsible`：右侧「…」按钮切换 `showBrowser`。  
   - 若有 loading/error：右侧 loading 或错误图标（hideError 时可不显示错误图标）。

2. **Collapse**  
   - `in={!collapsible || showBrowser}`：非折叠模式或用户展开时显示列表。  
   - 列表内容：  
     - **topDirectory**：当存在 `currentDirectory` 且有 `parent` 时，渲染一项「上一级」，点击调用 `goUp()`（若当前为 defaultDirectories 之一则清空，否则 `setInstant(parent)`）。  
     - **selectableDirectories**：当有 `currentDirectory` 时用 `directories`，否则用 `defaultDirectories`；每项为按钮，点击 `setInstant(dir)` 将该路径写入并请求新一层。

因此，**任意时刻列表里只有「一个父级 + 若干直接子目录」**，即单叉结构。

### 3.3 目录数据来源：useDirectoryPaths 与 Directory 查询

**useDirectoryPaths.ts**：

```ts
const { data, loading, error } = useDirectory(path);
const directories = error && hideError ? [] : currentData?.directory.directories;
const parent = currentData?.directory.parent;
```

- `path` 为空时，后端会归一化为首页（见下）；前端用 `directories` 与 `parent` 驱动列表。
- loading 期间用 `prevData` 保留上一帧数据，避免列表闪烁。

**GraphQL**（config.graphql）：

```graphql
query Directory($path: String) {
  directory(path: $path) {
    path
    parent
    directories
  }
}
```

**Directory 类型**（config.graphql）：

```text
type Directory {
  path: String!
  parent: String
  directories: [String!]!
}
```

- **path**：当前请求的目录路径（归一化后）。
- **parent**：父目录路径，根目录时为 null。
- **directories**：当前目录下**直接子目录**的完整路径列表（仅一层）。

---

## 4. 后端目录解析与单层列表

### 4.1 Directory 解析器（resolver_query_configuration.go）

```go
func (r *queryResolver) Directory(ctx context.Context, path, locale *string) (*Directory, error) {
  directory := &Directory{}
  col := newCollator(locale, collate.IgnoreCase, collate.Numeric)
  dirPath := ""
  if path != nil {
    dirPath = *path
  }
  currentDir := getDir(dirPath)
  directories, err := listDir(col, currentDir)
  // ...
  directory.Path = currentDir
  directory.Parent = getParent(currentDir)
  directory.Directories = directories
  return directory, err
}
```

- **getDir(path)**：若 path 为空则返回 `fsutil.GetHomeDirectory()`，否则返回 path；即空 path 时列出用户主目录。
- **getParent(path)**：若为 `/` 返回 nil；否则返回 `filepath.Clean(path + "/..")`，即父目录。
- **listDir(col, path)**：仅返回**该 path 下直接子目录**的完整路径列表（见下）。

### 4.2 listDir（dir_list.go）

- 使用 `os.ReadDir(path)` 读取当前目录项；若失败则退回到父目录再过滤名称前缀（兼容输入不完整路径）。
- 只保留 `file.IsDir() == true` 的项，并拼成完整路径：`filepath.Join(dirPath, file.Name())`。
- 若有 collator，则对目录名排序。
- **不递归**，因此返回的 `directories` 仅为**一层子目录**，与单叉结构一致。

---

## 5. PathFilter 与路径筛选条件

### 5.1 PathFilter 逻辑

- 从 `useConfigurationContext()` 取 `configuration.general.stashes`，得到 `libraryPaths`（库根路径数组）。
- 若 modifier 为 **MatchesRegex / NotMatchesRegex**：不显示文件夹浏览器，只显示一个 `Form.Control` 文本输入，直接写 criterion 的 value。
- 否则：渲染 **FolderSelect**，并传入：
  - `currentDirectory`：`criterion.value ? criterion.value.toString() : ""`
  - `onChangeDirectory`：`onValueChanged`（由 CriterionEditor 传入，即更新 criterion.value 并 setCriterion）
  - `collapsible`、`quotePath`、`hideError` 为 true
  - `defaultDirectories={libraryPaths}`：当前目录为空时，列表显示库根路径，用户可点击进入某一库再逐层下钻。

### 5.2 PathCriterion 与后端路径条件

- **PathCriterion** 继承 **StringCriterion**，类型为 `path`，默认 modifier **Includes**，value 为字符串（路径）。
- 在 CriterionEditor 中，`onValueChanged(value)` 会 `cloneDeep(criterion)` 并设 `newCriterion.value = value`，再 `setCriterion(newCriterion)`，因此路径字符串（及可选引号）写入 criterion。
- 后端在 Scene/Image/Gallery 等过滤中使用 **pathCriterionHandler**（criterion_handlers.go）：
  - 使用 `pathColumn` 与 `basenameColumn` 拼成完整路径，再根据 modifier 生成 LIKE / REGEXP 等条件。
  - Includes/Excludes 会加通配符并支持多词（按空格分）；Equals/NotEquals 不加通配符；MatchesRegex/NotMatchesRegex 用正则。

---

## 6. 路径含空格与引号（quotePath）

- PathFilter 启用 **quotePath**，FolderSelect 内：
  - 显示与请求目录时使用 **stripQuotes** 后的路径（避免 API 带引号）。
  - 写入 criterion 时若路径含空格则 **addQuotes** 包一层双引号。
- `TextUtils.stripQuotes`：去掉首尾一对双引号；`addQuotes`：在字符串外加 `"..."`。便于后端与存储中正确解析带空格路径。

---

## 7. 小结与注意点

1. **单叉结构**：路径选择器不做多级树展开，每次只展示「上一级」+ 当前目录的**直接子目录**，通过多次 `directory(path)` 请求逐层下钻或上溯。
2. **数据来源**：`directory(path)` 返回 `path`、`parent`、`directories[]`；后端 `listDir` 仅列一层子目录，`getParent` 返回 `path/..`。
3. **默认根**：路径为空时前端用 `defaultDirectories`（库路径）作为可选项；后端 `getDir("")` 返回主目录，因此若 PathFilter 未传 defaultDirectories 且用户清空路径，会看到主目录下的子目录。
4. **正则模式**：路径条件为「匹配正则」时只显示文本框，不显示 FolderSelect，无单叉浏览器。
5. **扩展**：若需「多选路径」或「树形多级展开」，需在前端增加多选/树组件，并在后端或查询层支持多路径/子树语义；当前实现仅为单路径、单层列表。

---

**报告结束。**
